---

title: Converting to deep zoom package 

keywords: fastai
sidebar: home_sidebar



---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: notebooks/01_deepzoom.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#exp_default deepzoom</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Converting an image into a deep zoom pyramid and publishing as deep zoom package in a b2 bucket, is a three step process: 1) convert to dzi pyramid, 2) upload pyramid to bucket, 3) create html and jsonp viewers.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">frank</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">Werkmappen_Software</span><span class="o">/</span><span class="n">dzi2b2</span> 
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>/mnt/datadisk/Work/Werkmappen_Software/dzi2b2
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># need a public image file in test via pooch? </span>
<span class="n">fname1</span> <span class="o">=</span> <span class="s1">&#39;/home/frank/Work/Projecten/DoRe/data/drawings/rma-web-highres/RP-T-1930-22_highres.png&#39;</span> 
<span class="n">fname2</span> <span class="o">=</span> <span class="s1">&#39;/home/frank/Work/Projecten/DoRe/data/drawings/rma-web-highres/RP-T-1930-51_highres.png&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">myb2keys</span>

<span class="n">application_key</span> <span class="o">=</span> <span class="n">myb2keys</span><span class="o">.</span><span class="n">application_key</span> 
<span class="n">application_key_id</span> <span class="o">=</span> <span class="n">myb2keys</span><span class="o">.</span><span class="n">application_key_id</span> 
<span class="n">bucket_name</span> <span class="o">=</span> <span class="n">myb2keys</span><span class="o">.</span><span class="n">bucket_name</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pyvips</span> 
<span class="kn">import</span> <span class="nn">os</span> 
<span class="kn">import</span> <span class="nn">shutil</span> 
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">re</span> 
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span> 
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span> 
<span class="kn">import</span> <span class="nn">b2sdk.v1</span> <span class="k">as</span> <span class="nn">b2</span>

<span class="n">ROOTDIR</span> <span class="o">=</span> <span class="s1">&#39;deepzoom&#39;</span>

<span class="k">class</span> <span class="nc">DeepZoomStore</span><span class="p">:</span> 
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="sd">&#39;&#39;&#39;Create local deep zoom store directory for one or more images. &#39;&#39;&#39;</span>
        
        <span class="n">store_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ROOTDIR</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">store_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
        
        <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>

        
    <span class="k">def</span> <span class="nf">dzp_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span> 
        
        <span class="n">name</span> <span class="o">=</span> <span class="n">dzp_save</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        
        
    <span class="k">def</span> <span class="nf">connect_b2_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application_key_id</span><span class="p">,</span> <span class="n">application_key</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">):</span> 
        
        <span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span> <span class="o">=</span> <span class="n">bucket_name</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">b2_api</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">connect_b2_bucket</span><span class="p">(</span><span class="n">application_key_id</span><span class="p">,</span> <span class="n">application_key</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">)</span>
        
        
    <span class="k">def</span> <span class="nf">make_webviewers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">:</span> 
        
            <span class="n">dzi_to_js</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">)</span>
            <span class="n">make_html</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">)</span> <span class="c1"># single image viewer </span>


    <span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">upload</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b2_api</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">)</span>
        
                   

<span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="n">b2_api</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;&#39;&#39;&#39;</span>

    <span class="n">source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ROOTDIR</span><span class="p">)</span>
    <span class="n">destination</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;b2://</span><span class="si">{</span><span class="n">bucket_name</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">ROOTDIR</span><span class="si">}</span><span class="s1">&#39;</span>  

    <span class="n">source</span> <span class="o">=</span> <span class="n">b2</span><span class="o">.</span><span class="n">parse_sync_folder</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">b2_api</span><span class="p">)</span>
    <span class="n">destination</span> <span class="o">=</span> <span class="n">b2</span><span class="o">.</span><span class="n">parse_sync_folder</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">b2_api</span><span class="p">)</span>

    <span class="n">policies_manager</span> <span class="o">=</span> <span class="n">b2</span><span class="o">.</span><span class="n">ScanPoliciesManager</span><span class="p">(</span><span class="n">exclude_all_symlinks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">synchronizer</span> <span class="o">=</span> <span class="n">b2</span><span class="o">.</span><span class="n">Synchronizer</span><span class="p">(</span>
            <span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">policies_manager</span><span class="o">=</span><span class="n">policies_manager</span><span class="p">,</span>
            <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">allow_empty_source</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">no_progress</span> <span class="o">=</span> <span class="kc">False</span> 

    <span class="c1"># need to run this to actually synchronize </span>

    <span class="k">with</span> <span class="n">b2</span><span class="o">.</span><span class="n">SyncReport</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">no_progress</span><span class="p">)</span> <span class="k">as</span> <span class="n">reporter</span><span class="p">:</span>
            <span class="n">synchronizer</span><span class="o">.</span><span class="n">sync_folders</span><span class="p">(</span>
                <span class="n">source_folder</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
                <span class="n">dest_folder</span><span class="o">=</span><span class="n">destination</span><span class="p">,</span>
                <span class="n">now_millis</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)),</span>
                <span class="n">reporter</span><span class="o">=</span><span class="n">reporter</span><span class="p">,</span>
            <span class="p">)</span> 
            
        
    

<span class="k">def</span> <span class="nf">make_html</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">):</span> 
    
    <span class="n">html_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ROOTDIR</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;dzp_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_view.html&#39;</span><span class="p">)</span> 
    
    <span class="n">html</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">&lt;!DOCTYPE html&gt;</span>
<span class="s1">&lt;html&gt;</span>
<span class="s1">&lt;body style=&quot;width: 800px; height: 600px; background-color: snow&quot;&gt;</span>

<span class="s1">&lt;div id=&quot;openseadragon1&quot; style=&quot;width: 100%; height: 100%; background-color: gray&quot;&gt;&lt;/div&gt; </span>

<span class="s1">&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/openseadragon/2.4.2/openseadragon.min.js&quot; </span>
<span class="s1">        integrity=&quot;sha512-qvQYH6mPuE46uFcWLI8BdGaJpB5taX4lltbSIw5GF4iODh2xIgyz5ii1WpuzPFUknHCps0mi4mFGR44bjdZlZg==&quot; </span>
<span class="s1">        crossorigin=&quot;anonymous&quot;&gt;</span>
<span class="s1">&lt;/script&gt;</span>

<span class="s1">&lt;script type=&quot;text/javascript&quot;&gt;</span>
<span class="s1">var viewer = OpenSeadragon(</span><span class="se">{{</span><span class="s1"></span>
<span class="s1">    id: &quot;openseadragon1&quot;,</span>
<span class="s1">    prefixUrl: &quot;https://cdnjs.cloudflare.com/ajax/libs/openseadragon/2.4.2/images/&quot;, </span>
<span class="s1">    tileSources: &quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.dzi&quot;, </span>
<span class="s1"> </span><span class="se">}}</span><span class="s1">);</span>
<span class="s1">&lt;/script&gt;</span>


<span class="s1">&lt;/body&gt;</span>
<span class="s1">&lt;/html&gt;  </span>
<span class="s1">&#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">html_fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span> 
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving: </span><span class="si">{</span><span class="n">html_fname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
       
    
    
<span class="k">def</span> <span class="nf">dzi_to_js</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">):</span> 
    <span class="sd">&#39;&#39;&#39;Parse XML.dzi file into JSONP.js file. </span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}{</span><span class="n">bucket_name</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">ROOTDIR</span><span class="si">}</span><span class="s1">/dzp_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_files/&#39;</span>  
    <span class="n">dzi_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ROOTDIR</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;dzp_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.dzi&#39;</span><span class="p">)</span> 
    <span class="n">jsonp_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ROOTDIR</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;dzp_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.js&#39;</span><span class="p">)</span> 
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dzi_fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span> 
        <span class="n">lines</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
         
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="s1">&#39;xml&#39;</span><span class="p">)</span>

    <span class="n">Format</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Format&#39;</span><span class="p">]</span>
    <span class="n">Overlap</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Overlap&#39;</span><span class="p">]</span>
    <span class="n">TileSize</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;TileSize&#39;</span><span class="p">]</span>
    <span class="n">Height</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">Size</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Height&#39;</span><span class="p">]</span> 
    <span class="n">Width</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">Size</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Width&#39;</span><span class="p">]</span>

    <span class="n">jsonp</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;OpenSeadragon( </span><span class="se">\</span>
<span class="s1">    </span><span class="se">{{</span><span class="s1"></span>
<span class="s1">    id: &quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;, </span>
<span class="s1">    prefixUrl: &quot;https://cdnjs.cloudflare.com/ajax/libs/openseadragon/2.4.2/images/&quot;, </span>
<span class="s1">    tileSources: </span><span class="se">{{</span><span class="s1"></span>
<span class="s1">        Image: </span><span class="se">{{</span><span class="s1"></span>
<span class="s1">           xmlns:    &quot;http://schemas.microsoft.com/deepzoom/2008&quot;,</span>
<span class="s1">           Url:      &quot;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1">&quot;, </span>
<span class="s1">           Format: &quot;</span><span class="si">{</span><span class="n">Format</span><span class="si">}</span><span class="s1">&quot;, </span>
<span class="s1">           Overlap: &quot;</span><span class="si">{</span><span class="n">Overlap</span><span class="si">}</span><span class="s1">&quot;,  </span>
<span class="s1">           TileSize: &quot;</span><span class="si">{</span><span class="n">TileSize</span><span class="si">}</span><span class="s1">&quot;, </span>
<span class="s1">           Size: </span><span class="se">{{</span><span class="s1"></span>
<span class="s1">               Height: &quot;</span><span class="si">{</span><span class="n">Height</span><span class="si">}</span><span class="s1">&quot;, </span>
<span class="s1">               Width: &quot;</span><span class="si">{</span><span class="n">Width</span><span class="si">}</span><span class="s1">&quot; </span>
<span class="s1">            </span><span class="se">}}</span><span class="s1"></span>
<span class="s1">        </span><span class="se">}}</span><span class="s1"></span>
<span class="s1">    </span><span class="se">}}</span><span class="s1"></span>
<span class="s1">    </span><span class="se">}}</span><span class="s1">); </span>
<span class="s1">    &#39;&#39;&#39;</span>
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jsonp_fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving: </span><span class="si">{</span><span class="n">jsonp_fname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">jsonp</span><span class="p">)</span>
 

  

<span class="k">def</span> <span class="nf">connect_b2_bucket</span><span class="p">(</span><span class="n">application_key_id</span><span class="p">,</span> <span class="n">application_key</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">):</span> 
    
    <span class="sd">&#39;&#39;&#39;Creates upload connection to your Backblaze b2 bucket.&#39;&#39;&#39;</span>
    
    <span class="n">info</span> <span class="o">=</span> <span class="n">b2</span><span class="o">.</span><span class="n">InMemoryAccountInfo</span><span class="p">()</span>
    <span class="n">b2_api</span> <span class="o">=</span> <span class="n">b2</span><span class="o">.</span><span class="n">B2Api</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> 
    <span class="n">b2_api</span><span class="o">.</span><span class="n">authorize_account</span><span class="p">(</span><span class="s2">&quot;production&quot;</span><span class="p">,</span> <span class="n">application_key_id</span><span class="p">,</span> <span class="n">application_key</span><span class="p">)</span>  
    
    
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">b2_api</span><span class="o">.</span><span class="n">get_bucket_by_name</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span> 

    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">file_info</span><span class="o">.</span><span class="n">file_name</span> <span class="k">for</span> <span class="n">file_info</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">bucket</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">show_versions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">b2_api</span><span class="o">.</span><span class="n">get_download_url_for_file_name</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">]</span> 
    <span class="n">base_url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">urls</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> 
    
    <span class="k">return</span> <span class="n">b2_api</span><span class="p">,</span> <span class="n">base_url</span>

<span class="c1"># damn accidentally removed the dzp_save function  </span>
<span class="c1"># will abandon the python based file tree report function  </span>

<span class="k">def</span> <span class="nf">dzp_save</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span> 
    <span class="c1"># name = dzp_save(fname, report_tree=report_tree) </span>
    
    <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
    <span class="n">dzp_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ROOTDIR</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;dzp_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">dzi_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ROOTDIR</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;dzp_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.dzi&#39;</span><span class="p">)</span> 
    <span class="n">dzi_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ROOTDIR</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;dzp_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dzp_fname</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dzi_fname</span><span class="p">):</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">)</span>
        <span class="n">v_img</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> 
        <span class="n">v_img</span><span class="o">.</span><span class="n">dzsave</span><span class="p">(</span><span class="n">dzi_base</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Not overwriting existing files: </span><span class="si">{</span><span class="n">dzi_base</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">name</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dz</span> <span class="o">=</span> <span class="n">DeepZoomStore</span><span class="p">()</span>
<span class="n">dz</span><span class="o">.</span><span class="n">dzp_save</span><span class="p">(</span><span class="n">fname1</span><span class="p">)</span>

<span class="n">dz</span><span class="o">.</span><span class="n">connect_b2_bucket</span><span class="p">(</span><span class="n">application_key_id</span><span class="p">,</span> <span class="n">application_key</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">)</span>
<span class="n">dz</span><span class="o">.</span><span class="n">make_webviewers</span><span class="p">()</span>
<span class="n">dz</span><span class="o">.</span><span class="n">upload</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Not overwriting existing files: ./deepzoom/dzp_RP-T-1930-22_highres/RP-T-1930-22_highres
Saving: ./deepzoom/dzp_RP-T-1930-22_highres/RP-T-1930-22_highres.js
Saving: ./deepzoom/dzp_RP-T-1930-22_highres/RP-T-1930-22_highres_view.html
upload dzp_RP-T-1930-22_highres/RP-T-1930-22_highres.js                  
upload dzp_RP-T-1930-22_highres/RP-T-1930-22_highres_view.html           
                                                                         </pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Works!</p>

</div>
</div>
</div>
</div>
 

